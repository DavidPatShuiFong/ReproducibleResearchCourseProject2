---
title: "Reproducible Research: Peer Assessment 2"
output: 
  html_document:
    keep_md: true
---

## Project

Goal - To explore the NOAA Storm Database regarding severe weather events.

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

The data for this assignment is Storm Data from the National Weather Service. Documentation for the data can be found at the [National Weather Service](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) and [National Climatic Data Center Storm Events FAQ](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf)

## Data Processing

``` {r results='hide', message=FALSE, warning=FALSE}
### start necessary libraries
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)

### set figure save path to figure/
knitr::opts_chunk$set(fig.path = 'figure/')

```

## Download data

Data comes in the form of a comma-separated-value file compressed via the bzip2 algorithm.

``` {r cache=TRUE}
### download data ZIP file if necessary, and extract if necessary
if (!file.exists('StormData.csv.bz2')) {
  if (download.file('https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2','StormData.csv.bz2')) {
    stop('Unable to download data file')
  }
}

StormData <- as.tibble(read.csv(bzfile('StormData.csv.bz2')))

```

Variables of interest

Variable    | Description                 
------------|-----------------------------
BGN_DATE    | date of event starting
BGN_TIME    | time of event starting
TIME_ZONE   | time zone of event
COUNTYNAME  | name of county
STATE       | state of the United STates
EVTYPE      | type of event
FATALITIES  | number of fatalities        
INJURIES    | number of injuries
PROPDMG     | value of property damage in dollars
PROPDMGEXP  | property damage dollar multiplier (K thousands, M millions, B billions)
CROPDMG     | value of crop damage in dollars
CROPDMGEXP  | crop damage dollar multiplier (K thousands, M millions, B billions)
REFNUM      | unique reference number for event


### Extract times of storm commencement

Extract time information from *BGN_DATE*, *BGN_TIME* and *TIME_ZONE*, and store in *BEGIN_TIME*.

``` {r}

StormData$BEGIN_TIME <- strptime(paste(sub(' .*','',StormData$BGN_DATE),
                                       StormData$BGN_TIME),'%m/%d/%Y %H%M')
```

*TIME_ZONE* information, in particular, requires tidying up and adjustment.

List all current timezones, and standardize capitalization

``` {r}
print(unique(StormData$TIME_ZONE))
```
``` {r}

### some timezone names use 'lower-case' characters, convert all to upper-case
StormData$TIME_ZONE <- as.factor(toupper(StormData$TIME_ZONE))

```

List records with dubious timezone names

```{r, echo=TRUE}
print(StormData[StormData$TIME_ZONE %in% c('UNK','CSC','ESY','SCT'), c('COUNTYNAME','STATE','TIME_ZONE','REFNUM')])
```

Fill in corrected timezones.

Convert 'daylight saving' timezones to 'standard' timezones, as Lubridate adjusts for daylight saving times automatically.

``` {r}
### replace missing timezones 'UNK'
### Oconee County, Georgia
StormData[StormData$REFNUM == 23087,]$TIME_ZONE <- 'EST'
### Hawaii country, Hawaii
StormData[StormData$REFNUM == 27702,]$TIME_ZONE <- 'HST'
### Coles county, Illinois
StormData[StormData$REFNUM == 30669,]$TIME_ZONE <- 'CST'
### Rush County, Indiana
StormData[StormData$REFNUM == 35244,]$TIME_ZONE <- 'EST'
### Hampden County, Massachusetts
StormData[StormData$REFNUM == 67899,]$TIME_ZONE <- 'EST'
### Love County, Oklahoma
StormData[StormData$REFNUM == 120704,]$TIME_ZONE <- 'CST'
### Perkins County, South Dakota
StormData[StormData$REFNUM == 143198,]$TIME_ZONE <- 'MST'
### McLennan County, Texas
StormData[StormData$REFNUM == 154637,]$TIME_ZONE <- 'CST'
### Armstrong, Texas
StormData[StormData$REFNUM == 160236,]$TIME_ZONE <- 'CST'

### Chickasaw, Mississippi. likely mistaken timezone 'CSC'
StormData[StormData$REFNUM == 200720,]$TIME_ZONE <- 'CST'
### Cambria, Pennsylvania, likely mistaken timezone 'ESY'
StormData[StormData$REFNUM == 229824,]$TIME_ZONE <- 'EST'
### Shawano, Wisconsin, likely mistaken timezone 'SCT'
StormData[StormData$REFNUM == 247612,]$TIME_ZONE <- 'CST'
### IAZ033, Indiana, likely mistaken timezone 'SCT'
StormData[StormData$REFNUM == 201257,]$TIME_ZONE <- 'EST'

### convert daylight saving timezones to 'standard' time
StormData[StormData$TIME_ZONE == 'ADT',]$TIME_ZONE <- 'AST'
StormData[StormData$TIME_ZONE == 'CDT',]$TIME_ZONE <- 'CST'
StormData[StormData$TIME_ZONE == 'EDT',]$TIME_ZONE <- 'EST'
StormData[StormData$TIME_ZONE == 'MDT',]$TIME_ZONE <- 'MST'
StormData[StormData$TIME_ZONE == 'PDT',]$TIME_ZONE <- 'PST'

```

Finally, adjust *BEGIN_TIME* according to *TIME_ZONE*.

``` {r}

StormData[StormData$TIME_ZONE == 'AKS',]$BEGIN_TIME <- 
  force_tz(as.POSIXct(StormData[StormData$TIME_ZONE == 'AKS',]$BEGIN_TIME), tzone = 'America/Anchorage')
StormData[StormData$TIME_ZONE == 'AST',]$BEGIN_TIME <- 
  force_tz(as.POSIXct(StormData[StormData$TIME_ZONE == 'AST',]$BEGIN_TIME), tzone = 'America/Halifax')
StormData[StormData$TIME_ZONE == 'CST',]$BEGIN_TIME <- 
  force_tz(as.POSIXct(StormData[StormData$TIME_ZONE == 'CST',]$BEGIN_TIME), tzone = 'America/Chicago')
StormData[StormData$TIME_ZONE == 'EST',]$BEGIN_TIME <- 
  force_tz(as.POSIXct(StormData[StormData$TIME_ZONE == 'EST',]$BEGIN_TIME), tzone = 'America/New_York')
StormData[StormData$TIME_ZONE == 'HST',]$BEGIN_TIME <- 
  force_tz(as.POSIXct(StormData[StormData$TIME_ZONE == 'HST',]$BEGIN_TIME), tzone = 'Pacific/Honolulu')
StormData[StormData$TIME_ZONE == 'MST',]$BEGIN_TIME <- 
  force_tz(as.POSIXct(StormData[StormData$TIME_ZONE == 'MST',]$BEGIN_TIME), tzone = 'America/Denver')
StormData[StormData$TIME_ZONE == 'PST',]$BEGIN_TIME <- 
  force_tz(as.POSIXct(StormData[StormData$TIME_ZONE == 'PST',]$BEGIN_TIME), tzone = 'America/Los_Angeles')
StormData[StormData$TIME_ZONE == 'SST',]$BEGIN_TIME <- 
  force_tz(as.POSIXct(StormData[StormData$TIME_ZONE == 'SST',]$BEGIN_TIME), tzone = 'Pacific/Samoa')
### other timezones 'GMT', 'GST', and 'UTC' all appear to be UTC+0, and so left alone

```


